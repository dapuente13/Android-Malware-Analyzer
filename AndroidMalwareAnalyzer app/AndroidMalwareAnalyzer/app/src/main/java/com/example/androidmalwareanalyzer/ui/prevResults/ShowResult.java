package com.example.androidmalwareanalyzer.ui.prevResults;

import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageInfo;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;

import androidx.fragment.app.Fragment;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.example.androidmalwareanalyzer.R;
import com.example.androidmalwareanalyzer.ui.appsInformation.PackageInfoStruct;

import java.util.ArrayList;
import java.util.List;

public class ShowResult extends Fragment {
    private String date;
    private String type;
    private ArrayList<PackageInfoStruct> elements_analyzed;
    private String message_returned;
    private Context mContext;

    public ShowResult(Context context, String analysis_type, String analysis_date, String elements, String msg) {
        mContext = context;
        type = analysis_type;
        date = analysis_date;
        getInstalledApps(elements);
        message_returned =  msg;
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
        View root = inflater.inflate(R.layout.fragment_show_result, container, false);

        final TextView textView1 = root.findViewById(R.id.title_results);
        textView1.setText(type);

        final TextView textView2 = root.findViewById(R.id.date_results);
        textView2.setText(date);

        RecyclerView mRecyclerView = root.findViewById(R.id.elements_list);
        LinearLayoutManager layoutManager = new LinearLayoutManager(getContext());
        mRecyclerView.setLayoutManager(layoutManager);
        RecyclerView.Adapter mAdapter = new ElementsAdapter(getContext(), elements_analyzed);
        mRecyclerView.setAdapter(mAdapter);

        final TextView textView3 = root.findViewById(R.id.msg_results);
        textView3.setText(message_returned);



        return root;
    }

    private void getInstalledApps(String elements) {
        List<PackageInfo> packs = mContext.getPackageManager().getInstalledPackages(0);
        String[] filter_values = elements.split(",");
        boolean found;
        elements_analyzed = new ArrayList<PackageInfoStruct>();

        if (filter_values.length < 1 || elements.equals("")) {
            PackageInfoStruct newInfo = new PackageInfoStruct();
            newInfo.setAppName("Everything");
            newInfo.setAppIcon(null);
            elements_analyzed.add(newInfo);
        }
        else {
            for (int i = 0; i < filter_values.length; i++) {
                found = false;
                PackageInfoStruct newInfo = new PackageInfoStruct();

                for (int j = 0; j < packs.size() && !found; j++) {
                    PackageInfo p = packs.get(j);
                    if (filter_values[i].equals(p.packageName)) {
                        newInfo.setAppName(p.applicationInfo.loadLabel(mContext.getPackageManager()).toString());
                        newInfo.setPackageName(p.packageName);
                        newInfo.setAppIcon(p.applicationInfo.loadIcon(mContext.getPackageManager()));
                        found = true;
                    }
                }

                if (!found)
                    newInfo.setAppName(filter_values[i]);

                elements_analyzed.add(newInfo);
            }
        }
    }
}
